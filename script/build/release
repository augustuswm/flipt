#!/bin/bash

SHA1=$(git rev-parse HEAD | cut -c 1-7)

VERSION=$SHA1-t

set -euo pipefail

cd "$(dirname "$0")/../.." || exit

mkdir -p dist

rm -rf dist/$VERSION

mkdir dist/$VERSION
mkdir dist/$VERSION/config

docker build -t flipt-builder -f script/build/Dockerfile .
docker run -v "$PWD/dist/$VERSION":/out -t flipt-builder

cp -r config/migrations dist/$VERSION/config

tar -zcvf dist/$VERSION.tar.gz dist/$VERSION